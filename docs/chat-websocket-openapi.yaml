openapi: 3.0.3

info:
  title: Trilex Chat WebSocket API
  version: 2.2.0
  description: |
    WebSocket documentation for Trilex Chat System.

    This API uses a single authenticated WebSocket connection.
    All chat communication happens over one persistent socket.

    ------------------------------
    PROFESSIONAL MESSAGE LIFECYCLE
    ------------------------------

    1️ Frontend sends message with temporary UUID (client_temp_id)
    2️ Server saves message and returns message_sent (ACK)
    3️ Server broadcasts chat_message to room
    4️ Server emits room_updated to all participants (updates sidebar in real-time)
    5️ When recipient joins the room, server marks the latest message as delivered
    6️ Server sends message_delivered to sender
    7️ Recipient marks room read
    8️ Server sends message_read event

    ---------------------------------
    DELIVERY STRATEGY (Optimized)
    ---------------------------------

    - Delivery is NOT triggered per message manually.
    - Delivery is triggered automatically when recipient joins the room.
    - Only the latest pending message is marked as delivered.
    - Frontend marks earlier messages as delivered automatically.
    - This prevents event flooding and reduces socket traffic.

    ---------------------------------
    REAL-TIME SIDEBAR STRATEGY
    ---------------------------------

    - Whenever a new message is sent, server emits "room_updated".
    - Frontend must:
        1. Update last_message preview
        2. Update last_message_at timestamp
        3. Move the room to the top of the list
    - No API refresh is required.
    - Sidebar must always rely on WebSocket events.

servers:
  - url: ws://127.0.0.1:8000
    description: Local Development

  - url: wss://trilex-1.onrender.com
    description: Production (Render)

paths:
  /ws/socket/:
    get:
      summary: Connect to WebSocket
      description: |
        Establish authenticated WebSocket connection.

        ----------------------------------------
         Connection URLs
        ----------------------------------------

        Local:
        ws://127.0.0.1:8000/ws/socket/?token=<ACCESS_TOKEN>

        Production:
        wss://trilex-1.onrender.com/ws/socket/?token=<ACCESS_TOKEN>

        ----------------------------------------
         Frontend Example (Enterprise Flow)
        ----------------------------------------

        ```javascript
        const socket = new WebSocket(
          "wss://trilex-1.onrender.com/ws/socket/?token=YOUR_ACCESS_TOKEN"
        );

        socket.onopen = () => {
          console.log("Connected");

          socket.send(JSON.stringify({
            action: "join_room",
            room_id: "ROOM_ID"
          }));
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          switch(data.type) {

            case "room_joined":
              break;

            case "message_sent":
              // Replace temp message with real DB ID
              break;

            case "chat_message":
              // Render message in active room
              break;

            case "room_updated":
              // Update sidebar:
              // - update last message preview
              // - move room to top
              break;

            case "message_delivered":
              // Show double tick ✔✔
              break;

            case "message_read":
              // Show blue tick 
              break;
          }
        };

        function sendMessage(text) {
          const tempId = crypto.randomUUID();

          socket.send(JSON.stringify({
            action: "send_message",
            room_id: "ROOM_ID",
            message: text,
            client_temp_id: tempId
          }));
        }

        function markRoomRead(roomId) {
          socket.send(JSON.stringify({
            action: "mark_read",
            room_id: roomId
          }));
        }
        ```

      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: JWT Access Token

      responses:
        "101":
          description: Switching Protocols (WebSocket Connected)

components:
  schemas:

    JoinRoomRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: join_room
        room_id:
          type: string
          example: 8ba73eaa-414e-45f2-b3a6-b1e5cb77927c

    LeaveRoomRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: leave_room
        room_id:
          type: string

    SendMessageRequest:
      type: object
      required:
        - action
        - room_id
        - message
        - client_temp_id
      properties:
        action:
          type: string
          example: send_message
        room_id:
          type: string
        message:
          type: string
        client_temp_id:
          type: string

    MarkReadRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: mark_read
        room_id:
          type: string

    RoomJoinedResponse:
      type: object
      properties:
        type:
          type: string
          example: room_joined
        room_id:
          type: string

    RoomLeftResponse:
      type: object
      properties:
        type:
          type: string
          example: room_left
        room_id:
          type: string

    MessageSentResponse:
      type: object
      properties:
        type:
          type: string
          example: message_sent
        client_temp_id:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    ChatMessageResponse:
      type: object
      properties:
        type:
          type: string
          example: chat_message
        room_id:
          type: string
        message:
          type: string
        sender_id:
          type: string
        sender_email:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    RoomUpdatedResponse:
      type: object
      properties:
        type:
          type: string
          example: room_updated
        room_id:
          type: string
        last_message:
          type: string
        last_message_at:
          type: string
          format: date-time
        sender_id:
          type: string

    MessageDeliveredResponse:
      type: object
      properties:
        type:
          type: string
          example: message_delivered
        room_id:
          type: string
        message_id:
          type: string
        delivered_to:
          type: string

    MessageReadResponse:
      type: object
      properties:
        type:
          type: string
          example: message_read
        room_id:
          type: string
        reader_id:
          type: string

x-websocket-actions:

  join_room:
    description: |
      Join a chat room.
      Automatically triggers delivery for latest pending message.
    request:
      $ref: '#/components/schemas/JoinRoomRequest'
    response:
      $ref: '#/components/schemas/RoomJoinedResponse'

  leave_room:
    description: Leave a chat room.
    request:
      $ref: '#/components/schemas/LeaveRoomRequest'
    response:
      $ref: '#/components/schemas/RoomLeftResponse'

  send_message:
    description: |
      Send a message to a room.

      Flow:
      1️ message_sent (ACK - DB saved)
      2️ chat_message (broadcast to active room)
      3️ room_updated (update sidebar for all participants)
      4️ message_delivered (triggered when recipient joins room)
    request:
      $ref: '#/components/schemas/SendMessageRequest'
    responses:
      message_sent:
        $ref: '#/components/schemas/MessageSentResponse'
      chat_broadcast:
        $ref: '#/components/schemas/ChatMessageResponse'
      sidebar_update:
        $ref: '#/components/schemas/RoomUpdatedResponse'
      delivered:
        $ref: '#/components/schemas/MessageDeliveredResponse'

  mark_read:
    description: |
      Mark all messages in a room as read.
      Triggers message_read event to other participants.
    request:
      $ref: '#/components/schemas/MarkReadRequest'
    responses:
      read_event:
        $ref: '#/components/schemas/MessageReadResponse'
