openapi: 3.0.3

info:
  title: Trilex Chat WebSocket API
  version: 2.4.0
  description: |
    WebSocket documentation for Trilex Chat System.
    
    ============================================================
    OVERVIEW
    ============================================================
    
    • Single persistent authenticated WebSocket connection
    • JWT token must be passed as query parameter
    • All chat communication happens over this socket
    • Every server event contains a `type` field
    
    Connection format:
    
    Local:
    ws://127.0.0.1:8000/ws/socket/?token=<ACCESS_TOKEN>
    
    Production:
    wss://trilex-1.onrender.com/ws/socket/?token=<ACCESS_TOKEN>
    
    
    ============================================================
    SOCKET CONNECTION FLOW (Frontend Implementation Guide)
    ============================================================
    
    STEP 1 — CONNECT
    ----------------
    Frontend opens WebSocket connection.
    User is automatically added to personal group:
        user_<user_id>
    
    No room is joined automatically.
    
    ------------------------------------------------------------
    
    STEP 2 — JOIN ROOM
    ------------------
    Frontend sends:
    
    {
      "action": "join_room",
      "room_id": "<ROOM_ID>"
    }
    
    Server responds:
    
    Event: room_joined
    Schema: RoomJoinedResponse
    
    If there is a latest pending message from another user,
    server also triggers:
    
    Event: message_delivered
    Schema: MessageDeliveredResponse
    (Sent ONLY to original sender)
    
    ------------------------------------------------------------
    
    STEP 3 — SEND MESSAGE
    ---------------------
    
    Frontend sends:
    
    {
      "action": "send_message",
      "room_id": "<ROOM_ID>",
      "message": "Hello",
      "client_temp_id": "<UUID>"
    }
    
    Server emits events in this order:
    
    1) message_sent  
       → Sent ONLY to sender  
       → Schema: MessageSentResponse  
       → Purpose: ACK that DB saved message  
    
    2) chat_message  
       → Sent to ALL participants in room  
       → Schema: ChatMessageResponse  
       → Purpose: Real message delivery  
    
    3) room_updated  
       → Sent to ALL participants (user-level group)  
       → Schema: RoomUpdatedResponse  
       → Purpose: Sidebar update (preview + reorder room)
    
    ------------------------------------------------------------
    
    STEP 4 — RECEIVE MESSAGE
    ------------------------
    
    Frontend must listen for:
    
    Event: chat_message  
    Schema: ChatMessageResponse  
    
    This is the main event for receiving new messages.
    
    ------------------------------------------------------------
    
    STEP 5 — DELIVERY LOGIC
    -----------------------
    
    Delivery is NOT triggered per message manually.
    
    Delivery is automatically triggered when:
        A participant joins the room.
    
    Only the LATEST pending message is marked delivered.
    
    Event sent:
    message_delivered
    Schema: MessageDeliveredResponse
    Sent ONLY to original sender.
    
    Frontend should:
    • Mark latest message as delivered
    • Optionally mark older messages visually delivered
    
    This prevents WebSocket flooding.
    
    ------------------------------------------------------------
    
    STEP 6 — MARK READ
    ------------------
    
    Frontend sends:
    
    {
      "action": "mark_read",
      "room_id": "<ROOM_ID>"
    }
    
    Server sends to OTHER participants:
    
    Event: message_read
    Schema: MessageReadResponse
    
    Purpose:
    Indicates that a participant has read messages in this room.
    
    ============================================================
    EVENT LISTENER REFERENCE (Frontend Must Handle These)
    ============================================================
    
    room_joined       → RoomJoinedResponse  
    room_left         → RoomLeftResponse  
    message_sent      → MessageSentResponse  
    chat_message      → ChatMessageResponse   (MAIN MESSAGE EVENT)  
    room_updated      → RoomUpdatedResponse   (SIDEBAR EVENT)  
    message_delivered → MessageDeliveredResponse  
    message_read      → MessageReadResponse  
    
    ============================================================
    WEBSOCKET ACTIONS (What Frontend Can Send)
    ============================================================
    
    Action: join_room
    Purpose: Join a chat room
    Request Schema: JoinRoomRequest
    
    Action: leave_room
    Purpose: Leave room and stop receiving messages
    Request Schema: LeaveRoomRequest
    
    Action: send_message
    Purpose: Send new message
    Request Schema: SendMessageRequest
    
    Action: mark_read
    Purpose: Mark all messages in room as read
    Request Schema: MarkReadRequest
    
    ============================================================
    UNIFIED MESSAGE FORMAT
    ============================================================
    
    All message-related events use this sender structure:
    
    sender: {
      "id": string,
      "name": string,
      "email": string
    }
    
    Used in:
    • ChatMessageResponse
    • RoomUpdatedResponse
    
    ============================================================
    IMPORTANT DESIGN NOTES
    ============================================================
    
    • chat_message is the event to RECEIVE messages
    • send_message is the action to SEND messages
    • message_sent is only an ACK for sender
    • message_delivered triggers on room join
    • message_read triggers after mark_read
    • room_updated is ONLY for sidebar updates
    • API endpoints are used for pagination and history
    • WebSocket is used for real-time updates only


servers:
  - url: ws://127.0.0.1:8000
    description: Local Development

  - url: wss://trilex-1.onrender.com
    description: Production

paths:
  /ws/socket/:
    get:
      summary: Connect to WebSocket
      description: |
        Establish authenticated WebSocket connection.

        Connection URL Format:
        wss://trilex-1.onrender.com/ws/socket/?token=<ACCESS_TOKEN>

        ============================================================
        FRONTEND IMPLEMENTATION TEMPLATE
        ============================================================

        ```javascript
        const socket = new WebSocket(
          "wss://trilex-1.onrender.com/ws/socket/?token=ACCESS_TOKEN"
        );

        socket.onopen = () => {
          console.log("Connected");
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          switch(data.type) {

            case "room_joined":
              // RoomJoinedResponse
              break;

            case "message_sent":
              // MessageSentResponse (ACK)
              break;

            case "chat_message":
              // ChatMessageResponse (RECEIVE MESSAGE HERE)
              break;

            case "room_updated":
              // RoomUpdatedResponse (Update sidebar)
              break;

            case "message_delivered":
              // MessageDeliveredResponse (Show ✔✔)
              break;

            case "message_read":
              // MessageReadResponse (Show blue ticks)
              break;
          }
        };

        function sendMessage(text) {
          const tempId = crypto.randomUUID();

          socket.send(JSON.stringify({
            action: "send_message",
            room_id: "ROOM_ID",
            message: text,
            client_temp_id: tempId
          }));
        }

        function markRoomRead(roomId) {
          socket.send(JSON.stringify({
            action: "mark_read",
            room_id: roomId
          }));
        }
        ```

      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: JWT Access Token

      responses:
        "101":
          description: WebSocket Connected

components:
  schemas:

    # ============================================================
    # REQUEST SCHEMAS
    # ============================================================

    JoinRoomRequest:
      type: object
      description: Sent by frontend to join a room.
      required: [action, room_id]
      properties:
        action:
          type: string
          example: join_room
        room_id:
          type: string

    LeaveRoomRequest:
      type: object
      description: Leave a room and stop receiving its messages.
      required: [action, room_id]
      properties:
        action:
          type: string
          example: leave_room
        room_id:
          type: string

    SendMessageRequest:
      type: object
      description: Send a new chat message.
      required: [action, room_id, message, client_temp_id]
      properties:
        action:
          type: string
          example: send_message
        room_id:
          type: string
        message:
          type: string
        client_temp_id:
          type: string
          description: Temporary ID used by frontend before DB ACK.

    MarkReadRequest:
      type: object
      description: Mark all messages in a room as read.
      required: [action, room_id]
      properties:
        action:
          type: string
          example: mark_read
        room_id:
          type: string

    # ============================================================
    # COMMON OBJECTS
    # ============================================================

    SenderObject:
      type: object
      description: Unified sender structure used in all message events.
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string

    # ============================================================
    # RESPONSE SCHEMAS
    # ============================================================

    RoomJoinedResponse:
      type: object
      description: Confirmation that user successfully joined room.
      properties:
        type:
          type: string
          example: room_joined
        room_id:
          type: string

    RoomLeftResponse:
      type: object
      description: Confirmation that user left room.
      properties:
        type:
          type: string
          example: room_left
        room_id:
          type: string

    MessageSentResponse:
      type: object
      description: ACK response to sender confirming DB save.
      properties:
        type:
          type: string
          example: message_sent
        client_temp_id:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    ChatMessageResponse:
      type: object
      description: |
        Primary event for receiving chat messages.
        All participants in the room receive this event.
      properties:
        type:
          type: string
          example: chat_message
        id:
          type: string
        room_id:
          type: string
        message:
          type: string
        created_at:
          type: string
          format: date-time
        sender:
          $ref: '#/components/schemas/SenderObject'

    RoomUpdatedResponse:
      type: object
      description: |
        Sidebar update event.
        Triggered whenever a new message is sent.
        Structure of last_message matches ChatMessageResponse
        (without the outer `type` field).
      properties:
        type:
          type: string
          example: room_updated
        room_id:
          type: string
        last_message:
          type: object
          properties:
            id:
              type: string
            room_id:
              type: string
            message:
              type: string
            created_at:
              type: string
              format: date-time
            sender:
              $ref: '#/components/schemas/SenderObject'
    

    MessageDeliveredResponse:
      type: object
      description: |
        Triggered when recipient joins room.
        Sent only to original sender.
      properties:
        type:
          type: string
          example: message_delivered
        room_id:
          type: string
        message_id:
          type: string
        delivered_to:
          type: string

    MessageReadResponse:
      type: object
      description: |
        Triggered when a participant marks room as read.
        Sent to other participants.
      properties:
        type:
          type: string
          example: message_read
        room_id:
          type: string
        reader_id:
          type: string