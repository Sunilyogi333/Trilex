openapi: 3.0.3

info:
  title: Trilex Chat WebSocket API
  version: 2.0.0
  description: |
    WebSocket documentation for Trilex Chat System.

    This API uses a single authenticated WebSocket connection.
    All chat communication happens over a single persistent socket.

    Architecture:
    - Frontend sends message with temporary UUID
    - Server responds with message_sent (ack)
    - Server broadcasts chat_message
    - Server sends message_delivered
    - Server sends message_read

servers:
  - url: ws://127.0.0.1:8000
    description: Local Development

  - url: wss://trilex-1.onrender.com
    description: Production (Render)

paths:
  /ws/socket/:
    get:
      summary: Connect to WebSocket
      description: |
        Establish authenticated WebSocket connection.

        ----------------------------------------

        ### üîó Connection URLs

        Local:
        ws://127.0.0.1:8000/ws/socket/?token=<ACCESS_TOKEN>

        Production:
        wss://trilex-1.onrender.com/ws/socket/?token=<ACCESS_TOKEN>

        ----------------------------------------

        ### üíª Frontend JavaScript Example (Professional Flow)

        ```javascript
        const socket = new WebSocket(
          "wss://trilex-1.onrender.com/ws/socket/?token=YOUR_ACCESS_TOKEN"
        );

        socket.onopen = () => {
          console.log("Connected");

          // Join room
          socket.send(JSON.stringify({
            action: "join_room",
            room_id: "ROOM_ID"
          }));
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log("Server:", data);

          switch(data.type) {
            case "message_sent":
              console.log("Message saved:", data.message_id);
              break;

            case "message_delivered":
              console.log("Delivered ‚úî‚úî");
              break;

            case "message_read":
              console.log("Read üëÅ");
              break;
          }
        };

        function sendMessage(text) {
          const tempId = crypto.randomUUID();

          socket.send(JSON.stringify({
            action: "send_message",
            room_id: "ROOM_ID",
            message: text,
            client_temp_id: tempId
          }));
        }
        ```

      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: JWT Access Token

      responses:
        "101":
          description: Switching Protocols (WebSocket Connected)

components:
  schemas:

    # =============================
    # REQUEST SCHEMAS
    # =============================

    JoinRoomRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: join_room
        room_id:
          type: string
          example: 8ba73eaa-414e-45f2-b3a6-b1e5cb77927c

    SendMessageRequest:
      type: object
      required:
        - action
        - room_id
        - message
        - client_temp_id
      properties:
        action:
          type: string
          example: send_message
        room_id:
          type: string
        message:
          type: string
          example: Hello
        client_temp_id:
          type: string
          example: temp-uuid-1234

    MarkReadRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: mark_read
        room_id:
          type: string

    # =============================
    # RESPONSE SCHEMAS
    # =============================

    RoomJoinedResponse:
      type: object
      properties:
        type:
          type: string
          example: room_joined
        room_id:
          type: string

    MessageSentResponse:
      type: object
      properties:
        type:
          type: string
          example: message_sent
        client_temp_id:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    ChatMessageResponse:
      type: object
      properties:
        type:
          type: string
          example: chat_message
        room_id:
          type: string
        message:
          type: string
        sender:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    MessageDeliveredResponse:
      type: object
      properties:
        type:
          type: string
          example: message_delivered
        room_id:
          type: string
        message_id:
          type: string

    MessageReadResponse:
      type: object
      properties:
        type:
          type: string
          example: message_read
        room_id:
          type: string
        reader_id:
          type: string

    NewMessageNotification:
      type: object
      properties:
        type:
          type: string
          example: new_message_notification
        room_id:
          type: string
        message_preview:
          type: string

# =============================
# WEBSOCKET ACTIONS
# =============================

x-websocket-actions:

  join_room:
    description: Join a chat room.
    request:
      $ref: '#/components/schemas/JoinRoomRequest'
    response:
      $ref: '#/components/schemas/RoomJoinedResponse'

  send_message:
    description: |
      Send a message to a room.

      Flow:
      1. message_sent (ack)
      2. chat_message (broadcast)
      3. message_delivered
    request:
      $ref: '#/components/schemas/SendMessageRequest'
    responses:
      message_sent:
        $ref: '#/components/schemas/MessageSentResponse'
      chat_broadcast:
        $ref: '#/components/schemas/ChatMessageResponse'
      delivered:
        $ref: '#/components/schemas/MessageDeliveredResponse'
      notification:
        $ref: '#/components/schemas/NewMessageNotification'

  mark_read:
    description: Mark all messages in a room as read.
    request:
      $ref: '#/components/schemas/MarkReadRequest'
    responses:
      read_event:
        $ref: '#/components/schemas/MessageReadResponse'
