openapi: 3.0.3

info:
  title: Trilex Chat WebSocket API
  version: 2.0.0
  description: |
    WebSocket documentation for Trilex Chat System.

    This API uses a single authenticated WebSocket connection.
    All chat communication happens over one persistent socket.

    ------------------------------
    PROFESSIONAL MESSAGE LIFECYCLE
    ------------------------------

    1Ô∏è‚É£ Frontend sends message with temporary UUID (client_temp_id)
    2Ô∏è‚É£ Server saves message and returns message_sent (ACK)
    3Ô∏è‚É£ Server broadcasts chat_message to room
    4Ô∏è‚É£ Recipient confirms delivery via message_received
    5Ô∏è‚É£ Server sends message_delivered to sender
    6Ô∏è‚É£ Recipient marks room read
    7Ô∏è‚É£ Server sends message_read event

servers:
  - url: ws://127.0.0.1:8000
    description: Local Development

  - url: wss://trilex-1.onrender.com
    description: Production (Render)

paths:
  /ws/socket/:
    get:
      summary: Connect to WebSocket
      description: |
        Establish authenticated WebSocket connection.

        ----------------------------------------
        üîó Connection URLs
        ----------------------------------------

        Local:
        ws://127.0.0.1:8000/ws/socket/?token=<ACCESS_TOKEN>

        Production:
        wss://trilex-1.onrender.com/ws/socket/?token=<ACCESS_TOKEN>

        ----------------------------------------
        üíª Frontend Example (Enterprise Flow)
        ----------------------------------------

        ```javascript
        const socket = new WebSocket(
          "wss://trilex-1.onrender.com/ws/socket/?token=YOUR_ACCESS_TOKEN"
        );

        socket.onopen = () => {
          console.log("Connected");

          socket.send(JSON.stringify({
            action: "join_room",
            room_id: "ROOM_ID"
          }));
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          switch(data.type) {

            case "message_sent":
              // Replace temp message with real ID
              break;

            case "chat_message":
              // Show message in UI
              // Immediately confirm delivery
              socket.send(JSON.stringify({
                action: "message_received",
                room_id: data.room_id,
                message_id: data.message_id
              }));
              break;

            case "message_delivered":
              // Update ‚úî‚úî status
              break;

            case "message_read":
              // Update blue ticks
              break;
          }
        };

        function sendMessage(text) {
          const tempId = crypto.randomUUID();

          socket.send(JSON.stringify({
            action: "send_message",
            room_id: "ROOM_ID",
            message: text,
            client_temp_id: tempId
          }));
        }
        ```

      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: JWT Access Token

      responses:
        "101":
          description: Switching Protocols (WebSocket Connected)

components:
  schemas:

    # =============================
    # REQUEST SCHEMAS
    # =============================

    JoinRoomRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: join_room
        room_id:
          type: string
          example: 8ba73eaa-414e-45f2-b3a6-b1e5cb77927c

    SendMessageRequest:
      type: object
      required:
        - action
        - room_id
        - message
        - client_temp_id
      properties:
        action:
          type: string
          example: send_message
        room_id:
          type: string
        message:
          type: string
          example: Hello
        client_temp_id:
          type: string
          example: temp-uuid-1234

    MessageReceivedRequest:
      type: object
      required:
        - action
        - room_id
        - message_id
      properties:
        action:
          type: string
          example: message_received
        room_id:
          type: string
        message_id:
          type: string

    MarkReadRequest:
      type: object
      required:
        - action
        - room_id
      properties:
        action:
          type: string
          example: mark_read
        room_id:
          type: string

    # =============================
    # RESPONSE SCHEMAS
    # =============================

    RoomJoinedResponse:
      type: object
      properties:
        type:
          type: string
          example: room_joined
        room_id:
          type: string

    MessageSentResponse:
      type: object
      properties:
        type:
          type: string
          example: message_sent
        client_temp_id:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    ChatMessageResponse:
      type: object
      properties:
        type:
          type: string
          example: chat_message
        room_id:
          type: string
        message:
          type: string
        sender_id:
          type: string
        sender_email:
          type: string
        message_id:
          type: string
        created_at:
          type: string
          format: date-time

    MessageDeliveredResponse:
      type: object
      properties:
        type:
          type: string
          example: message_delivered
        room_id:
          type: string
        message_id:
          type: string
        delivered_to:
          type: string

    MessageReadResponse:
      type: object
      properties:
        type:
          type: string
          example: message_read
        room_id:
          type: string
        reader_id:
          type: string

# =============================
# WEBSOCKET ACTIONS
# =============================

x-websocket-actions:

  join_room:
    description: Join a chat room after WebSocket connection.
    request:
      $ref: '#/components/schemas/JoinRoomRequest'
    response:
      $ref: '#/components/schemas/RoomJoinedResponse'

  send_message:
    description: |
      Send a message to a room.

      Flow:
      1Ô∏è‚É£ message_sent (ACK - DB saved)
      2Ô∏è‚É£ chat_message (broadcast)
      3Ô∏è‚É£ message_delivered (after recipient confirms)
    request:
      $ref: '#/components/schemas/SendMessageRequest'
    responses:
      message_sent:
        $ref: '#/components/schemas/MessageSentResponse'
      chat_broadcast:
        $ref: '#/components/schemas/ChatMessageResponse'
      delivered:
        $ref: '#/components/schemas/MessageDeliveredResponse'

  message_received:
    description: |
      Recipient confirms message delivery.
      This triggers message_delivered event to sender.
    request:
      $ref: '#/components/schemas/MessageReceivedRequest'

  mark_read:
    description: |
      Mark all messages in a room as read.
      Triggers message_read event to other participants.
    request:
      $ref: '#/components/schemas/MarkReadRequest'
    responses:
      read_event:
        $ref: '#/components/schemas/MessageReadResponse'
